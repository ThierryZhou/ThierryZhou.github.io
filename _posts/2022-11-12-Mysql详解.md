---
titile: mysql innodb 详解
---

从InnoDB存储引擎的存储结构看，所有数据都被逻辑地放在一个空间中，称之为表空间(tablespace)、区(extent)、页(page)组成，页在一些文档中也被称之为块(block)。

1、InnoDB逻辑存储结构

![mysql-innodb](/assets/images/posts/mysql-innodb.png)

1.1、表空间(Tablespace)

表空间可以看做InnoDB逻辑结构的最高层，所有的数据都放在表空间中。

在默认情况下，InnoDB存储引擎都有一个共享表空间ibdata1，即所有数据都存放在这个表空间内。如果用户启用了参数innodb_file_per_table，则每张表内的数据可以单独放到一个表空间内。

如果启用了innodb_file_per_table参数，也需要注意，每张表的表空间存放的只是数据、索引和插入缓冲Bitmap页，其它类的数据，如回滚(undo)信息，插入缓冲索引页、系统事务信息，二次写缓冲等还是存放在原来的共享表空间内。

1.2、段(Segment)

表空间是由各个段组成的，常见的段有数据段、索引段、回滚段等。

InnoDB存储引擎表是索引组织(index organized)的，因此数据即索引，索引即数据。那么数据段即为B+树的叶子节点(Leaf node segment)，索引段即为B+树的非索引节点(Non-leaf node segment)，这些内容在后面的索引学习里会详细介绍。

1.3、区(extend)

区是由连续页组成的空间，在任何情况下每个区的大小都为1MB。为了保证区中页的连续性，InonoDB存储引擎一次从磁盘申请4-5个区。在默认情况下，InnoDB存储引擎的页的大小为16KB，即一个区中应有64个连续的页。

InnoDB1.0.x版本开始引入压缩页，每个页的大小可以通过参数KEY_BLOCK_SIZE设置为2K、4K、8K，因此每个区对应的页尾512、256、128.

InnoDB1.2.x版本新增了参数innodb_page_size，通过该参数可以将默认页的大小设置为4K、8K，但是页中的数据不是压缩的。

但是有时候为了节约磁盘容量的开销，创建表默认大小是96KB，区中是64个连续的页。(对于一些小表)

1.4、页(page)

页是InnoDB存储引擎磁盘管理的最小单位，每个页默认16KB;InnoDB存储引擎从1.2.x版本开始，可以通过参数innodb_page_size将页的大小设置为4K、8K、16K。

若设置完成，则所有表中页的大小都为innodb_page_size，不可以再次对其进行修改，除非通过mysqldump导入和导出操作来产生新的库。

innoDB存储引擎中，常见的页类型有：

数据页(B-tree Node)
undo页(undo Log Page)
系统页 (System Page)
事务数据页 (Transaction System Page)
插入缓冲位图页(Insert Buffer Bitmap)
插入缓冲空闲列表页(Insert Buffer Free List)
未压缩的二进制大对象页(Uncompressed BLOB Page)
压缩的二进制大对象页 (compressed BLOB Page)
1.5、行(row)

InnoDB存储引擎是面向行的(row-oriented)，也就是说数据是按行进行存放的，每个页存放的行记录也是有硬性定义的，最多允许存放16KB/2-200，即7992行记录。

2、InnoDB 行记录格式
InnoDB 存储引擎和大多数数据库一样(如 Oracle 和 Microsoft SQL Server 数据库)，记录是以行的形式存储的。这意味着页中保存着表中一行行的数据。在 InnoDB 1.0x 版本之前，InnoDB 存储引擎提供了 Compact 和 Redundant 两种格式来存放行记录数据，这也是目前使用最多的一种格式。

2.1、Compact 行记录格式

Compact 行记录是在 MySQL 5.0 中引人的，其设计目标是髙效地存储数据。简单来说,一个页中存放的行数据越多，其性能就越髙。

下图显示了 Compact 行记录的存储方式：

![mysql-innodb-row](/assets/images/posts/mysql-innodb-row.png)

Compact 行记录格式的首部是一个非 NULL 变长字段长度列表，并且其是按照列的顺序逆序放置的，其长度为：

若列的长度小于 255 字节，用 1 字节表示;
若大于 255 个字节，用2 字节表示。
变长字段的长度最大不可以超过 2 字节，这是因在 MySQL 数据库中 VARCHAR 类型的最大长度限制为 65535。变长字段之后的第二个部分是 NULL 标志位，该位指示了该行数据中是否有 NULL 值，有则用 1 表示。

需要特别注意的是，NULL 不占该部分任何空间，即 NULL 除了占有 NULL 标志位，实际存储不占有任何空间。另外有一点需要注意的是，每行数据除了用户定义的列外，还有两个隐藏列，事务 1D 列和回滚指针列,分别为 6 字节和 7 字节的大小。若 InnoDB 表没有定义主键，每行还会增加一个 6 字节的 rowid 列。

Redundant 是 MySQL 5 . 0 版本之前 InnoDB 的 行 记 录 存 储 方 式，这里就不展开。

2.2、行溢出数据

InnoDB 存储引擎可以将一条记录中的某些数据存储在真正的数据页之外。因为一般数据页默认大小为16KB，假如一个数据页存储不了插入的数据，这时肯定就会发生行溢出。

![mysql-innodb-page](/assets/images/posts/mysql-innodb-page.png)

一般认为 BLOB、LOB 这类的大对象列类型的存储会把数据存放在数据页之外。但是，BLOB 也可以不将数据放在溢出页面，而且即便是 VARCHAR 列数据类型，依然有可能被存放为行溢出数据。

3、InnoDB 数据页结构
页是 InnoDB 存储引擎管理数据库最小磁盘单位。页类型为 B-tree Node 的页存放的即是表中行的实际数据了。

InnoDB 数据页由以下 7 个部分组成:

File Header (文件头)

Page Header (页头)
Infimun 和 Supremum Records
User Records (用户记录，即行记录)
Free Space (空闲空间)
Page Directory (页目录)
File Trailer (文件结尾信息)

![mysql-innodb-header](/assets/images/posts/mysql-innodb-header.png)

## 更多技术分享浏览我的博客：  
https://thierryzhou.github.io

## 参考
- [1] [MySQL高级进阶：关于InnoDB存储结构，一文深入分析讲解](https://www.51cto.com/article/673996.html)